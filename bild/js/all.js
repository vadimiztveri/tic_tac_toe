function Application(){this.players=new Application.Players(["cross","zero","square"]),this.ui=new Application.UI(this),$(this.ui).on("start",this.ui_start_event_handler.bind(this)).on("restart",this.ui_restart_event_handler.bind(this)).on("cell",this.ui_turn_event_handler.bind(this))}Application.prototype.run=function(){this.ui.attach_handlers()},Application.prototype.ui_start_event_handler=function(a,b,c){this.start(b,c)},Application.prototype.ui_restart_event_handler=function(){this.restart()},Application.prototype.ui_turn_event_handler=function(a,b,c){this.game.can_turn(b,c)&&this.game.step(b,c)},Application.prototype.start=function(a,b){this.board_size=a,this.win_length=b,this.board=this.board_factory(),this.game=this.game_factory(),this.game.start()},Application.prototype.restart=function(){this.board=this.board_factory(),this.game=this.game_factory(),this.game.start()},Application.prototype.board_factory=function(){return new Application.Board(this.board_size)},Application.prototype.game_factory=function(){return new Application.Game(this.players,this.board,this.win_length)},Application.Board=function(){function a(a){this.size_board=a,this.rows=this.create_rows()}return a.prototype.create_rows=function(){for(var a=[],b=0;b<this.size_board;b++){for(var c=[],d=0;d<this.size_board;d++)c.push(new Application.Board.Cell);a.push(c)}return a},a.prototype.get_chip=function(a,b){return this.rows[a][b].chip?this.rows[a][b].chip:void 0},a.prototype.get_win=function(a,b){return this.rows[a][b].win?!0:void 0},a}(),Application.Board.Cell=function(){function a(){}return a.prototype.set_chip=function(a){this.chip=a},a.prototype.set_win=function(){this.win=!0},a}(),Application.Board.Chip=function(){function a(a){this.name=a}return a}(),Application.Players=function(){function a(a){this.names_chips=a,this.players=this.create_players(),this.current_index=0}return a.prototype.create_players=function(){for(var a,b=[],c=0;c<this.names_chips.length;c++)a=this.player_factory(c),b.push(a);return b},a.prototype.player_factory=function(a){return new Application.Players.Player(new Application.Board.Chip(this.names_chips[a]),"Игрок "+(a+1))},a.prototype.change_player=function(){switch(this.current_index){case this.players.length-1:this.current_index=0;break;default:this.current_index=this.current_index+1}},a.prototype.get_current=function(){return this.players[this.current_index]},a}(),Application.Players.Player=function(){function a(a,b){this.chip=a,this.name=b}return a.prototype.get_chip=function(){return this.chip.name},a.prototype.set_next_player=function(a){this.next_player=a},a}(),Application.UI=function(){function a(){}return a.prototype.attach_handlers=function(){this.report_click_in_start(),this.report_click_in_restart(),this.click_in_cell()},a.prototype.report_click_in_start=function(){$("#start").on("click",function(){var a=Number($("#size-board").val()),b=Number($("#win_length").val());return this.errors(a,b)?alert(this.errors(a,b)):$(this).trigger("start",[a,b]),!1}.bind(this))},a.prototype.errors=function(a,b){return 1>a||a>10?"Ширина доски должна быть от 1 до 10.":b>a?"Длина победной линии из фишек не может быть длиннее ширины доски.":3>b?"Длина победной линии из фишек не может быть меньше 3.":void 0},a.prototype.report_click_in_restart=function(){$("#restart").on("click",function(){return $(this).trigger("restart"),!1}.bind(this))},a.prototype.click_in_cell=function(){$("#board").on("click",function(a){var b=""+$(a.target).attr("role");return $(this).trigger("cell",[b[5],b[6]]),!1}.bind(this))},a}(),Application.Painter=function(){function a(a){this.game=a}return a.prototype.redraw=function(){this.set_players(),this.set_end_game(),this.set_board(),"0"===$("#game-area").css("opacity")&&this.set_game_visible()},a.prototype.set_game_visible=function(){$("#game-area").animate({opacity:1}),$("#board").animate({opacity:1})},a.prototype.set_players=function(){for(var a=0;a<this.game.players.players.length;a++){var b="#gamer"+(a+1);this.game.players.get_current()===this.game.players.players[a]?$(b).css("color","#000"):$(b).css("color","#ddd"),$(b).html(this.game.players.players[a].name+" <img src='png/"+this.game.players.players[a].chip.name+".png'>")}},a.prototype.set_end_game=function(){if(this.game.end)if(this.game.end===this.game.VICTORY)var a="Победил: "+this.game.players.get_current().name+".";else var a="Ничья.";else var a="";$("#winner").html(a)},a.prototype.set_board=function(){for(var a="",b=0;b<this.game.board.size_board;b++){a+="<tr>";for(var c=0;c<this.game.board.size_board;c++)a+=this.set_cell(b,c);a+="</tr>"}this.display(a)},a.prototype.set_cell=function(a,b){var c="cell-"+a+b,d="",e="";return this.game.board.get_chip(a,b)&&(d=this.set_chip(this.game.board.get_chip(a,b))),this.game.board.get_win(a,b)&&(e="class=win"),"<td role='"+c+"' "+d+e+"></td>"},a.prototype.set_chip=function(a){return" style=\"background-image:url('png/"+a+".png')\""},a.prototype.display=function(a){$("#board").html(a)},a}(),Application.Game=function(){function a(a,b,c){this.players=a,this.win_length=c,this.step_number=0,this.end=!1,this.board=b}return a.prototype.start=function(){this.redraw()},a.prototype.step=function(a,b){this.last_turn=new Application.Game.Turn(this.players.get_current().get_chip(),[a,b],this.board,this.win_length),this.last_turn.is_victory()?this.ended_in_victory():this.is_last_step()?this.ended_in_standoff():this.prepare_next_turn(),this.redraw()},a.prototype.prepare_next_turn=function(){this.change_current_player(),this.step_number++},a.prototype.is_last_step=function(){return this.step_number===this.board.size_board*this.board.size_board-1?!0:void 0},a.prototype.change_current_player=function(){this.players.change_player()},a.prototype.can_turn=function(a,b){return this.board.get_chip(a,b)||this.end?void 0:!0},a.prototype.VICTORY=1,a.prototype.STANDOFF=2,a.prototype.ended_in_victory=function(){this.end=this.VICTORY},a.prototype.ended_in_standoff=function(){this.end=this.STANDOFF},a.prototype.redraw=function(){this.painter=new Application.Painter(this),this.painter.redraw()},a}(),Application.Game.Turn=function(){function a(a,b,c,d){this.current_chip=a,this.row=Number(b[0]),this.cell=Number(b[1]),this.board=c,this.win_length=d,this.set_chip()}return a.prototype.set_chip=function(){this.board.rows[this.row][this.cell].set_chip(this.current_chip)},a.prototype.is_victory=function(){return this.is_horizontal_win()||this.is_vertical_win()||this.is_diagonal_down_win()||this.is_diagonal_up_win()},a.prototype.is_horizontal_win=function(){var a=this.ahead(0,1),b=this.back(0,1),c=a+b[0];return c>=this.win_length?(this.set_win_cells_horizontal(this.row,this.cell-b[1],c),!0):void 0},a.prototype.is_vertical_win=function(){var a=this.ahead(1,0),b=this.back(1,0),c=a+b[0];return c>=this.win_length?(this.set_win_cells_vertical(this.row-b[1],this.cell,c),!0):void 0},a.prototype.is_diagonal_down_win=function(){var a=this.back(1,1),b=this.ahead(1,1),c=b+a[0];return c>=this.win_length?(this.set_win_cells_diagonal_down(this.row-a[1],this.cell-a[1],c),!0):void 0},a.prototype.is_diagonal_up_win=function(){var a=this.back(1,-1),b=this.ahead(1,-1),c=b+a[0];return c>=this.win_length?(this.set_win_cells_diagonal_up(this.row-a[1],this.cell+a[1],c),!0):void 0},a.prototype.ahead=function(a,b){for(var c=0,d=1;d<this.win_length;d++){var e=this.row+d*a,f=this.cell+d*b;if(!(e<this.board.size_board&&this.board.rows[e][f]&&this.board.rows[e][f].chip===this.current_chip))break;c++}return c},a.prototype.back=function(a,b){for(var c=0,d=0,e=0;e<this.win_length;e++){var f=this.row-e*a,g=this.cell-e*b;if(!(f>-1&&this.board.rows[f][g]&&this.board.rows[f][g].chip===this.current_chip))break;c++,d=e}return[c,d]},a.prototype.set_win_cells_horizontal=function(a,b,c){for(var d=0;c>d;d++)this.board.rows[a][b+d].set_win()},a.prototype.set_win_cells_vertical=function(a,b,c){for(var d=0;c>d;d++)this.board.rows[a+d][b].set_win()},a.prototype.set_win_cells_diagonal_down=function(a,b,c){for(var d=0;c>d;d++)this.board.rows[a+d][b+d].set_win()},a.prototype.set_win_cells_diagonal_up=function(a,b,c){for(var d=0;c>d;d++)this.board.rows[a+d][b-d].set_win()},a}();var app=new Application;app.run();